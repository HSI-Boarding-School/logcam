name: Build and Deploy to Ubuntu Server

on:
  push:
    branches: [ main, master ]

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_BACKEND: ghcr.io/${{ github.repository }}/backend
  IMAGE_FRONTEND: ghcr.io/${{ github.repository }}/frontend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./infra/docker/backend.Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_BACKEND }}:${{ github.sha }}
            ${{ env.IMAGE_BACKEND }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./client
          file: ./client/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_FRONTEND }}:${{ github.sha }}
            ${{ env.IMAGE_FRONTEND }}:latest
          build-args: |
            VITE_API_BASE=https://logcam.naflatech.com/api
            VITE_WS_BASE=wss://logcam.naflatech.com
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push nginx web image (static frontend)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./infra/docker/web.Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ github.repository }}/web:${{ github.sha }}
            ghcr.io/${{ github.repository }}/web:latest
          build-args: |
            VITE_API_BASE=https://logcam.naflatech.com/api
            VITE_WS_BASE=wss://logcam.naflatech.com
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script_stop: true
          envs: GITHUB_SHA
          script: |
            set -euo pipefail
            cd /opt/logcam || mkdir -p /opt/logcam && cd /opt/logcam
            # clone or update repo (optional). If you prefer rsync, switch to scp/rsync in a separate step.
            if [ ! -d .git ]; then
              git init
              git remote add origin https://github.com/${{ github.repository }}.git
              git fetch --depth=1 origin ${{ github.ref_name }}
              git checkout -B ${{ github.ref_name }} FETCH_HEAD
            else
              git fetch --depth=1 origin ${{ github.ref_name }}
              git checkout -B ${{ github.ref_name }} FETCH_HEAD
            fi

            # Ensure Docker & Compose available (Ubuntu 22 setup)
            if ! command -v docker >/dev/null 2>&1; then
              echo "Docker not found. Install Docker first." >&2
              exit 1
            fi

            export BACKEND_IMAGE=ghcr.io/${{ github.repository }}/backend:${GITHUB_SHA}
            export FRONTEND_IMAGE=ghcr.io/${{ github.repository }}/frontend:${GITHUB_SHA}
            export NGINX_IMAGE=ghcr.io/${{ github.repository }}/web:${GITHUB_SHA}

            docker login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}

            # Pull images and run with compose (base + prod + deploy override)
            docker compose -f infra/compose/docker-compose.yml -f infra/compose/docker-compose.prod.yml -f infra/compose/docker-compose.deploy.yml pull || true
            docker compose -f infra/compose/docker-compose.yml -f infra/compose/docker-compose.prod.yml -f infra/compose/docker-compose.deploy.yml up -d

            # Run DB migrations/init if needed (not applicable here since SQLAlchemy creates tables on start)
